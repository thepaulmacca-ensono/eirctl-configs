# Pipelines Tasks

tasks:
  ado:retain:pipeline:
    context: powershell
    description: Retain a Pipeline run for a configurable number of years
    command:
      - |
        $retentionYears = [int]$env:RETENTION_YEARS
        $daysValid = 365 * $retentionYears
        $contentType = "application/json"
        $headers = @{ Authorization = "Bearer $env:ADO_ACCESS_TOKEN" }
        $rawRequest = @{
            daysValid       = $daysValid
            definitionId    = $env:SYSTEM_DEFINITIONID
            ownerId         = "User:$env:BUILD_REQUESTEDFORID"
            protectPipeline = $false
            runId           = $env:BUILD_BUILDID
        }
        $request = ConvertTo-Json @($rawRequest)
        $uri = "$env:SYSTEM_COLLECTIONURI$env:SYSTEM_TEAMPROJECT/_apis/build/retention/leases?api-version=6.0-preview.1"
        $response = Invoke-RestMethod -uri $uri -method POST -Headers $headers -ContentType $contentType -Body $request
        Write-Host "Pipeline run successfully retained for $retentionYears year(s)."
